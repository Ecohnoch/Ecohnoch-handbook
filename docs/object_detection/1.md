# R-CNN 名词索引

R-CNN 是目标检测中二阶段检测框架，代表性工作有 Fast R-CNN、Faster R-CNN、Mask R-CNN 等。第一个阶段是产生候选框，第二个阶段是对候选框进行回归以及分类，得到最终的检测结果。

## RPN

全称是 Region Proposal Network，这个网络主要是用来产生候选框的。在 Faster R-CNN 中，首先产生 anchor，然后对每个 anchor 进行分类和回归，最后对诸多框框进行剔除，得到质量较高的候选框。

### 产生 anchor

首先把 backbone 的特征图中每个像素值产生 k 个大小长宽不同的 anchor。每个 anchor 由四个数值表示，比如左上角和右上角的坐标。

### 分类与回归

RPN 有两个分支，一个分支是二分类，判断框住的目标是否为正样本；另一个分支是 bounding box regression，来计算边界框的偏移量，四个参数分别是【x 平移，y 平移，w 缩放，h 缩放】。

在训练过程中如果预测出来的框和 GT iou 大于某个阈值，那么则是样本，否则是负样本。通过偏移量也可以计算出实际框的位置，和 GT 计算出回归 loss。

### 非最大化抑制

由于每个像素点都会产生 k 个锚点，其中势必会有诸多重复、低质量、超出边界的，通常会用非最大化抑制（NMS），最终得到若干个质量较高的框。

### 训练

Faster R-CNN 的训练也是分多个阶段进行的，首先训练 RPN，训练好之后产生边界框再进行进一步分类（判断物体类别）与二次回归（得到更精确位置）。

### 参考教程

https://mp.weixin.qq.com/s/a3rXMAX9fOBg8e6amf1riA

## ROI

从 RPN 里面出来的 bbox 有各种各样的尺寸，但是后面的 head 只能处理单个尺寸。因此需要有一种方法来将特征处理成同一个尺寸方便后续处理。

### ROI Pooling

这个是以前最常使用的方法，简单来说就是把对应特征区域划分成 7×7 个子区域，然后取各个区域最大值作为特征输入到后面的网络。

### ROI Align

由于 ROI Pooling 会进行二次量化（浮点转换为整数），最终出来的特征可能和实际的对不上，因此 ROI Align 去掉了量化操作，直接划分成子区域，然后使用在子区域中取四个采样点，通过双线性插值得到结果，再通过取最大值得到特征。

### 参考链接

- https://zhuanlan.zhihu.com/p/37998710
- https://zhuanlan.zhihu.com/p/73113289